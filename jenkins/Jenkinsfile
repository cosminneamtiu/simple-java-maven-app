// Jenkinsfile — self-heal tools + safe checkout + auto POM
pipeline {
  agent any
  options { timestamps() }

  stages {

    stage('Setup tools & verify (self-heal JDK & Maven)') {
      steps {
        script {
          def JDK_TOOL_HOME = tool name: 'JDK21', type: 'hudson.model.JDK'
          def MAVEN_TOOL_HOME
          try {
            MAVEN_TOOL_HOME = tool name: 'Maven 3.9.x', type: 'hudson.tasks.Maven$MavenInstallation'
          } catch (ignored) {
            MAVEN_TOOL_HOME = tool name: 'Maven_3.9.x', type: 'hudson.tasks.Maven$MavenInstallation'
          }

          // --- JDK self-heal ---
          withEnv(["JDK_TOOL_HOME=${JDK_TOOL_HOME}"]) {
            sh '''
              set -euo pipefail
              d="$JDK_TOOL_HOME"
              echo "[info] JDK tool dir: $d"
              if ! find "$d" -type f -path "*/bin/java" -print -quit >/dev/null 2>&1; then
                echo "[warn] No JDK under $d — installing Temurin 21..."
                tmp="$(mktemp -d)"; cd "$tmp"
                curl -fL --retry 5 --connect-timeout 20 -o jdk21.tar.gz \
                  "https://api.adoptium.net/v3/binary/latest/21/ga/linux/x64/jdk/hotspot/normal/adoptium"
                tar -xzf jdk21.tar.gz
                root="$(tar -tzf jdk21.tar.gz | head -1 | cut -d/ -f1)"
                mkdir -p "$d"; rm -rf "$d"/*
                if [ -d "$root" ]; then mv "$root"/* "$d"/; else tar -xzf jdk21.tar.gz -C "$d"; fi
                cd /; rm -rf "$tmp"
                echo "[ok] Temurin 21 installed."
              fi
            '''
          }

          // --- Maven self-heal ---
          withEnv(["MAVEN_TOOL_HOME=${MAVEN_TOOL_HOME}"]) {
            sh '''
              set -euo pipefail
              m="$MAVEN_TOOL_HOME"
              echo "[info] Maven tool dir: $m"
              if [ ! -x "$m/bin/mvn" ]; then
                echo "[warn] No mvn at $m/bin/mvn — installing Apache Maven 3.9.11..."
                tmp="$(mktemp -d)"; cd "$tmp"
                curl -fL --retry 5 --connect-timeout 20 -o maven.tar.gz \
                  "https://archive.apache.org/dist/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.tar.gz"
                tar -xzf maven.tar.gz
                mkdir -p "$m"; rm -rf "$m"/*
                mv apache-maven-3.9.11/* "$m"/
                cd /; rm -rf "$tmp"
                echo "[ok] Maven 3.9.11 installed."
              fi
            '''
          }

          // --- Resolve JAVA_HOME & PATH ---
          withEnv(["JDK_TOOL_HOME=${JDK_TOOL_HOME}"]) {
            def RESOLVED_JAVA_HOME = sh(returnStdout: true, script: '''
              set -e
              d="$JDK_TOOL_HOME"
              if [ -x "$d/bin/java" ]; then echo "$d"; else
                f="$(find "$d" -type f -path "*/bin/java" -print -quit || true)"
                [ -n "$f" ] && dirname "$(dirname "$f")" || { echo "no-java"; exit 1; }
              fi
            ''').trim()
            if (RESOLVED_JAVA_HOME == 'no-java') { error('JAVA_HOME could not be resolved.') }

            env.JAVA_HOME = RESOLVED_JAVA_HOME
            env.PATH = "${RESOLVED_JAVA_HOME}/bin:${MAVEN_TOOL_HOME}/bin:${env.PATH}"
          }

          sh '''
            echo "[info] JAVA_HOME=$JAVA_HOME"
            echo "[info] which java => $(which java)"
            echo "[info] which mvn  => $(which mvn)"
            java -version
            mvn -v
          '''
        }
      }
    }

    // CLEAN BEFORE CHECKOUT (Jenkins does an implicit checkout before stages, which we might have wiped)
    stage('Clean workspace') {
      steps {
        deleteDir()
      }
    }

    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Locate POM') {
      steps {
        script {
          env.POM_PATH = sh(returnStdout: true, script: '''
            set -e
            # Quote the workspace path (yours contains a space)
            f="$(find "$PWD" -type f -name pom.xml -not -path "*/.git/*" | head -n1 || true)"
            if [ -z "$f" ]; then
              echo "No pom.xml found in workspace $(pwd)" >&2
              exit 2
            fi
            echo "$f"
          ''').trim()
          env.POM_DIR = sh(returnStdout: true, script: 'dirname "$POM_PATH"').trim()
          echo "[info] Using pom at: ${env.POM_PATH}"
        }
      }
    }

    stage('Build') {
      steps {
        dir("${env.POM_DIR}") {
          sh 'mvn -B -DskipTests clean package'
        }
      }
    }

    stage('Test') {
      steps {
        dir("${env.POM_DIR}") {
          sh 'mvn -B test'
        }
      }
    }

    stage('Deliver') {
      steps {
        dir("${env.POM_DIR}") {
          archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
        }
      }
    }

    stage('Complete') {
      steps { echo '✅ Pipeline finished.' }
    }
  }
}
